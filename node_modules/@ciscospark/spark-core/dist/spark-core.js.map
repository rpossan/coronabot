{"version":3,"sources":["spark-core.js"],"names":["registerPlugin","registerInternalPlugin","interceptors","SparkTrackingIdInterceptor","create","RequestEventInterceptor","RateLimitInterceptor","RequestLoggerInterceptor","process","env","ENABLE_NETWORK_LOGGING","ENABLE_VERBOSE_NETWORK_LOGGING","undefined","ResponseLoggerInterceptor","RequestTimingInterceptor","UrlInterceptor","SparkUserAgentInterceptor","AuthInterceptor","KmsDryErrorInterceptor","PayloadTransformerInterceptor","ConversationInterceptor","RedirectInterceptor","HttpStatusInterceptor","error","SparkHttpError","NetworkTimingInterceptor","preInterceptors","postInterceptors","SparkCore","AmpState","extend","version","children","internal","SparkInternalCore","constructor","attrs","options","credentials","supertoken","access_token","forEach","path","val","derived","boundedStorage","deps","fn","unboundedStorage","ready","loaded","_children","reduce","name","session","config","type","default","request","setOnce","sessionId","refresh","transform","direction","object","predicates","payloadTransformer","filter","p","ctx","spark","all","map","test","then","shouldTransform","extract","target","data","d","Boolean","promise","alias","applyNamedTransform","resolve","rest","unshift","args","transforms","tx","getWindow","window","initialize","trigger","onLoaded","stopListening","nextTick","listenToAndRun","onReady","prototype","key","listenTo","addInterceptor","ints","interceptor","push","includes","json","uuid","v4","inspect","depth","util","serialize","props","logout","token","refresh_token","onBeforeLogout","reverse","plugin","catch","err","logger","warn","clear","invalidate","authorization","measure","metrics","sendUnstructured","upload","file","reject","Error","phases","finalize","method","withCredentials","body","headers","shunt","EventEmitter","_uploadPhaseInitialize","_uploadPhaseUpload","_uploadPhaseFinalize","res","debug","_uploadApplySession","opts","phaseOptions","phaseKey","startsWith","substr","NODE_ENV","on","event","info","total","retry"],"mappings":"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","file":"spark-core.js","sourcesContent":["/*!\n * Copyright (c) 2015-2017 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {proxyEvents, retry, transferEvents} from '@ciscospark/common';\nimport {HttpStatusInterceptor, defaults as requestDefaults} from '@ciscospark/http-core';\nimport {defaults, get, has, isFunction, isString, last, merge, omit, set, unset} from 'lodash';\nimport AmpState from 'ampersand-state';\nimport AuthInterceptor from './interceptors/auth';\nimport NetworkTimingInterceptor from './interceptors/network-timing';\nimport PayloadTransformerInterceptor from './interceptors/payload-transformer';\nimport RedirectInterceptor from './interceptors/redirect';\nimport RequestEventInterceptor from './interceptors/request-event';\nimport RequestLoggerInterceptor from './interceptors/request-logger';\nimport RequestTimingInterceptor from './interceptors/request-timing';\nimport ResponseLoggerInterceptor from './interceptors/response-logger';\nimport SparkHttpError from './lib/spark-http-error';\nimport SparkTrackingIdInterceptor from './interceptors/spark-tracking-id';\nimport SparkUserAgentInterceptor from './interceptors/spark-user-agent';\nimport RateLimitInterceptor from './interceptors/rate-limit';\nimport config from './config';\nimport {makeSparkStore} from './lib/storage';\nimport util from 'util';\nimport uuid from 'uuid';\nimport {EventEmitter} from 'events';\nimport mixinSparkCorePlugins from './lib/spark-core-plugin-mixin';\nimport mixinSparkInternalCorePlugins from './lib/spark-internal-core-plugin-mixin';\nimport SparkInternalCore from './spark-internal-core';\n\n// TODO replace the Interceptor.create with Reflect.construct (\n// Interceptor.create exists because new was really hard to call on an array of\n// constructors)\nconst interceptors = {\n  SparkTrackingIdInterceptor: SparkTrackingIdInterceptor.create,\n  RequestEventInterceptor: RequestEventInterceptor.create,\n  RateLimitInterceptor: RateLimitInterceptor.create,\n  /* eslint-disable no-extra-parens */\n  RequestLoggerInterceptor: (process.env.ENABLE_NETWORK_LOGGING || process.env.ENABLE_VERBOSE_NETWORK_LOGGING) ? RequestLoggerInterceptor.create : undefined,\n  ResponseLoggerInterceptor: (process.env.ENABLE_NETWORK_LOGGING || process.env.ENABLE_VERBOSE_NETWORK_LOGGING) ? ResponseLoggerInterceptor.create : undefined,\n  /* eslint-enable no-extra-parens */\n  RequestTimingInterceptor: RequestTimingInterceptor.create,\n  UrlInterceptor: undefined,\n  SparkUserAgentInterceptor: SparkUserAgentInterceptor.create,\n  AuthInterceptor: AuthInterceptor.create,\n  KmsDryErrorInterceptor: undefined,\n  PayloadTransformerInterceptor: PayloadTransformerInterceptor.create,\n  ConversationInterceptor: undefined,\n  RedirectInterceptor: RedirectInterceptor.create,\n  HttpStatusInterceptor() {\n    return HttpStatusInterceptor.create({\n      error: SparkHttpError\n    });\n  },\n  NetworkTimingInterceptor: NetworkTimingInterceptor.create\n};\n\nconst preInterceptors = [\n  'ResponseLoggerInterceptor',\n  'RequestTimingInterceptor',\n  'RequestEventInterceptor',\n  'SparkTrackingIdInterceptor',\n  'RateLimitInterceptor'\n];\n\nconst postInterceptors = [\n  'HttpStatusInterceptor',\n  'NetworkTimingInterceptor',\n  'RequestLoggerInterceptor',\n  'RateLimitInterceptor'\n];\n\n/**\n * @class\n */\nconst SparkCore = AmpState.extend({\n  version: PACKAGE_VERSION,\n\n  children: {\n    internal: SparkInternalCore\n  },\n\n  constructor(attrs = {}, options) {\n    if (typeof attrs === 'string') {\n      attrs = {\n        credentials: {\n          supertoken: {\n            // eslint-disable-next-line camelcase\n            access_token: attrs\n          }\n        }\n      };\n    }\n    else {\n      // Reminder: order is important here\n      [\n        'credentials.authorization',\n        'authorization',\n        'credentials.supertoken.supertoken',\n        'supertoken',\n        'access_token',\n        'credentials.authorization.supertoken'\n      ].forEach((path) => {\n        const val = get(attrs, path);\n        if (val) {\n          unset(attrs, path);\n          set(attrs, 'credentials.supertoken', val);\n        }\n      });\n\n      [\n        'credentials',\n        'credentials.authorization'\n      ]\n        .forEach((path) => {\n          const val = get(attrs, path);\n          if (typeof val === 'string') {\n            unset(attrs, path);\n            set(attrs, 'credentials.supertoken', val);\n          }\n        });\n\n      if (typeof get(attrs, 'credentials.access_token') === 'string') {\n        set(attrs, 'credentials.supertoken', attrs.credentials);\n      }\n    }\n\n    return Reflect.apply(AmpState, this, [attrs, options]);\n  },\n\n  derived: {\n    boundedStorage: {\n      deps: [],\n      fn() {\n        return makeSparkStore('bounded', this);\n      }\n    },\n    unboundedStorage: {\n      deps: [],\n      fn() {\n        return makeSparkStore('unbounded', this);\n      }\n    },\n    ready: {\n      deps: ['loaded', 'internal.ready'],\n      fn() {\n        return this.loaded && Object.keys(this._children).reduce((ready, name) => ready && this[name] && this[name].ready !== false, true);\n      }\n    }\n  },\n\n  session: {\n    config: {\n      type: 'object'\n    },\n    /**\n     * When true, indicates that the initial load from the storage layer is\n     * complete\n     * @instance\n     * @memberof SparkCore\n     * @type {boolean}\n     */\n    loaded: {\n      default: false,\n      type: 'boolean'\n    },\n    request: {\n      setOnce: true,\n      // It's supposed to be a function, but that's not a type defined in\n      // Ampersand\n      type: 'any'\n    },\n    sessionId: {\n      setOnce: true,\n      type: 'string'\n    }\n  },\n\n  /**\n   * @instance\n   * @memberof SparkCore\n   * @param {[type]} args\n   * @returns {[type]}\n   */\n  refresh(...args) {\n    return this.credentials.refresh(...args);\n  },\n\n  /**\n   * Applies the directionally appropriate transforms to the specified object\n   * @param {string} direction\n   * @param {Object} object\n   * @returns {Promise}\n   */\n  transform(direction, object) {\n    const predicates = this.config.payloadTransformer.predicates.filter((p) => !p.direction || p.direction === direction);\n    const ctx = {\n      spark: this\n    };\n    return Promise.all(predicates.map((p) => p.test(ctx, object)\n      .then((shouldTransform) => {\n        if (!shouldTransform) {\n          return undefined;\n        }\n        return p.extract(object)\n          // eslint-disable-next-line max-nested-callbacks\n          .then((target) => ({\n            name: p.name,\n            target\n          }));\n      })))\n      .then((data) => data\n        .filter((d) => Boolean(d))\n        // eslint-disable-next-line max-nested-callbacks\n        .reduce((promise, {name, target, alias}) => promise.then(() => {\n          if (alias) {\n            return this.applyNamedTransform(direction, alias, target);\n          }\n          return this.applyNamedTransform(direction, name, target);\n        }), Promise.resolve()))\n      .then(() => object);\n  },\n\n  /**\n   * Applies the directionally appropriate transform to the specified parameters\n   * @param {string} direction\n   * @param {Object} ctx\n   * @param {string} name\n   * @returns {Promise}\n   */\n  applyNamedTransform(direction, ctx, name, ...rest) {\n    if (isString(ctx)) {\n      rest.unshift(name);\n      name = ctx;\n      ctx = {\n        spark: this,\n        transform: (...args) => this.applyNamedTransform(direction, ctx, ...args)\n      };\n    }\n\n    const transforms = ctx.spark.config.payloadTransformer.transforms.filter((tx) => tx.name === name && (!tx.direction || tx.direction === direction));\n    // too many implicit returns on the same line is difficult to interpret\n    // eslint-disable-next-line arrow-body-style\n    return transforms.reduce((promise, tx) => promise.then(() => {\n      if (tx.alias) {\n        return ctx.transform(tx.alias, ...rest);\n      }\n      return Promise.resolve(tx.fn(ctx, ...rest));\n    }), Promise.resolve())\n      .then(() => last(rest));\n  },\n\n  /**\n   * @private\n   * @returns {Window}\n   */\n  getWindow() {\n    // eslint-disable-next-line\n    return window;\n  },\n\n  /**\n   * Initializer\n   *\n   * @emits SparkCore#loaded\n   * @emits SparkCore#ready\n   * @instance\n   * @memberof SparkCore\n   * @param {Object} attrs\n   * @returns {SparkCore}\n   */\n  initialize(attrs = {}) {\n    this.config = merge({}, config, attrs.config);\n\n    // There's some unfortunateness with the way {@link AmpersandState#children}\n    // get initialized. We'll fire the change:config event so that\n    // {@link SparkPlugin#initialize()} can use\n    // `this.listenToOnce(parent, 'change:config', () => {});` to act on config\n    // during initialization\n    this.trigger('change:config');\n\n    const onLoaded = () => {\n      if (this.loaded) {\n        /**\n         * Fires when all data has been loaded from the storage layer\n         * @event loaded\n         * @instance\n         * @memberof SparkCore\n         */\n        this.trigger('loaded');\n\n        this.stopListening(this, 'change:loaded', onLoaded);\n      }\n    };\n\n    // This needs to run on nextTick or we'll never be able to wire up listeners\n    process.nextTick(() => {\n      this.listenToAndRun(this, 'change:loaded', onLoaded);\n    });\n\n    const onReady = () => {\n      if (this.ready) {\n        /**\n         * Fires when all plugins have fully initialized\n         * @event ready\n         * @instance\n         * @memberof SparkCore\n         */\n        this.trigger('ready');\n\n        this.stopListening(this, 'change:ready', onReady);\n      }\n    };\n\n    // This needs to run on nextTick or we'll never be able to wire up listeners\n    process.nextTick(() => {\n      this.listenToAndRun(this, 'change:ready', onReady);\n    });\n\n    // Make nested events propagate in a consistent manner\n    Object.keys(this.constructor.prototype._children).forEach((key) => {\n      this.listenTo(this[key], 'change', (...args) => {\n        args.unshift(`change:${key}`);\n        this.trigger(...args);\n      });\n    });\n\n    const addInterceptor = (ints, key) => {\n      const interceptor = interceptors[key];\n\n      if (!isFunction(interceptor)) {\n        return ints;\n      }\n\n      ints.push(Reflect.apply(interceptor, this, []));\n\n      return ints;\n    };\n\n    let ints = [];\n    ints = preInterceptors.reduce(addInterceptor, ints);\n    ints = Object.keys(interceptors).filter((key) => !(preInterceptors.includes(key) || postInterceptors.includes(key))).reduce(addInterceptor, ints);\n    ints = postInterceptors.reduce(addInterceptor, ints);\n\n    this.request = requestDefaults({\n      json: true,\n      interceptors: ints\n    });\n\n    let sessionId = `${get(this, 'config.trackingIdPrefix', 'spark-js-sdk')}_${get(this, 'config.trackingIdBase', uuid.v4())}`;\n    if (has(this, 'config.trackingIdPrefix')) {\n      sessionId += `_${get(this, 'config.trackingIdPrefix')}`;\n    }\n\n    this.sessionId = sessionId;\n  },\n\n  /**\n   * @instance\n   * @memberof SparkPlugin\n   * @param {number} depth\n   * @private\n   * @returns {Object}\n   */\n  inspect(depth) {\n    return util.inspect(omit(this.serialize({\n      props: true,\n      session: true,\n      derived: true\n    }), 'boundedStorage', 'unboundedStorage', 'request', 'config'), {depth});\n  },\n\n  /**\n   * Invokes all `onBeforeLogout` handlers in the scope of their plugin, clears\n   * all stores, and revokes the access token\n   * Note: If you're using the sdk in a server environment, you may be more\n   * interested in {@link `spark.internal.mercury.disconnect()`| Mercury#disconnect()}\n   * and {@link `spark.internal.device.unregister()`|Device#unregister()}\n   * or {@link `spark.phone.unregister()`|Phone#unregister}\n   * @instance\n   * @memberof SparkCore\n   * @param {Object} options Passed as the first argument to all\n   * `onBeforeLogout` handlers\n   * @returns {Promise}\n   */\n  logout(options, ...rest) {\n    // prefer the refresh token, but for clients that don't have one, fallback\n    // to the access token\n    const token = this.credentials.supertoken && (this.credentials.supertoken.refresh_token || this.credentials.supertoken.access_token);\n    options = Object.assign({token}, options);\n    // onBeforeLogout should be executed in the opposite order in which handlers\n    // were registered. In that way, wdm unregister() will be above mercury\n    // disconnect(), but disconnect() will execute first.\n    // eslint-disable-next-line arrow-body-style\n    return this.config.onBeforeLogout.reverse().reduce((promise, {plugin, fn}) => promise.then(() => {\n      return Promise.resolve(Reflect.apply(fn, this[plugin] || this.internal[plugin], [options, ...rest]))\n        // eslint-disable-next-line max-nested-callbacks\n        .catch((err) => {\n          this.logger.warn(`onBeforeLogout from plugin ${plugin}: failed`, err);\n        });\n    }), Promise.resolve())\n      .then(() => Promise.all([\n        this.boundedStorage.clear(),\n        this.unboundedStorage.clear()\n      ]))\n      .then(() => this.credentials.invalidate(...rest))\n      .then(() => this.authorization && this.authorization.logout && this.authorization.logout(options, ...rest))\n      .then(() => this.trigger('client:logout'));\n  },\n\n  /**\n   * General purpose wrapper to submit metrics via the metrics plugin (if the\n   * metrics plugin is installed)\n   * @instance\n   * @memberof SparkCore\n   * @returns {Promise}\n   */\n  measure(...args) {\n    if (this.metrics) {\n      return this.metrics.sendUnstructured(...args);\n    }\n\n    return Promise.resolve();\n  },\n\n  upload(options) {\n    if (!options.file) {\n      return Promise.reject(new Error('`options.file` is required'));\n    }\n\n    options.phases = options.phases || {};\n    options.phases.initialize = options.phases.initialize || {};\n    options.phases.upload = options.phases.upload || {};\n    options.phases.finalize = options.phases.finalize || {};\n\n    defaults(options.phases.initialize, {\n      method: 'POST'\n    }, omit(options, 'file', 'phases'));\n\n    defaults(options.phases.upload, {\n      method: 'PUT',\n      json: false,\n      withCredentials: false,\n      body: options.file,\n      headers: {\n        'x-trans-id': uuid.v4(),\n        authorization: undefined\n      }\n    });\n\n    defaults(options.phases.finalize, {\n      method: 'POST'\n    }, omit(options, 'file', 'phases'));\n\n    const shunt = new EventEmitter();\n\n    const promise = this._uploadPhaseInitialize(options)\n      .then(() => {\n        const p = this._uploadPhaseUpload(options);\n        transferEvents('progress', p, shunt);\n        return p;\n      })\n      .then((...args) => this._uploadPhaseFinalize(options, ...args))\n      .then((res) => res.body);\n\n    proxyEvents(shunt, promise);\n\n    return promise;\n  },\n\n  _uploadPhaseInitialize: function _uploadPhaseInitialize(options) {\n    this.logger.debug('client: initiating upload session');\n\n    return this.request(options.phases.initialize)\n      .then((...args) => this._uploadApplySession(options, ...args))\n      .then((res) => {\n        this.logger.debug('client: initiated upload session');\n        return res;\n      });\n  },\n\n  _uploadApplySession(options, res) {\n    const session = res.body;\n    ['upload', 'finalize'].reduce((opts, key) => {\n      opts[key] = Object.keys(opts[key]).reduce((phaseOptions, phaseKey) => {\n        if (phaseKey.startsWith('$')) {\n          phaseOptions[phaseKey.substr(1)] = phaseOptions[phaseKey](session);\n          Reflect.deleteProperty(phaseOptions, phaseKey);\n        }\n\n        return phaseOptions;\n      }, opts[key]);\n\n      return opts;\n    }, options.phases);\n  },\n\n  @retry\n  _uploadPhaseUpload(options) {\n    this.logger.debug('client: uploading file');\n\n    const promise = this.request(options.phases.upload)\n      .then((res) => {\n        this.logger.debug('client: uploaded file');\n        return res;\n      });\n\n    proxyEvents(options.phases.upload.upload, promise);\n\n    /* istanbul ignore else */\n    if (process.env.NODE_ENV === 'test') {\n      promise.on('progress', (event) => {\n        this.logger.info('upload progress', event.loaded, event.total);\n      });\n    }\n\n    return promise;\n  },\n\n  _uploadPhaseFinalize: function _uploadPhaseFinalize(options) {\n    this.logger.debug('client: finalizing upload session');\n\n    return this.request(options.phases.finalize)\n      .then((res) => {\n        this.logger.debug('client: finalized upload session');\n        return res;\n      });\n  }\n});\n\nSparkCore.version = PACKAGE_VERSION;\n\nmixinSparkInternalCorePlugins(SparkInternalCore, config, interceptors);\nmixinSparkCorePlugins(SparkCore, config, interceptors);\n\nexport default SparkCore;\n\n/**\n * @method registerPlugin\n * @param {string} name\n * @param {function} constructor\n * @param {Object} options\n * @param {Array<string>} options.proxies\n * @param {Object} options.interceptors\n * @returns {null}\n */\nexport function registerPlugin(name, constructor, options) {\n  SparkCore.registerPlugin(name, constructor, options);\n}\n\n/**\n * Registers plugins used by internal products that do not talk to public APIs.\n * @method registerInternalPlugin\n * @param {string} name\n * @param {function} constructor\n * @param {Object} options\n * @param {Object} options.interceptors\n * @private\n * @returns {null}\n */\nexport function registerInternalPlugin(name, constructor, options) {\n  SparkInternalCore.registerPlugin(name, constructor, options);\n}\n"]}