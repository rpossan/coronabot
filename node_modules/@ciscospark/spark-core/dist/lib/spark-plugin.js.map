{"version":3,"sources":["spark-plugin.js"],"names":["SparkPlugin","AmpState","extend","derived","boundedStorage","deps","fn","unboundedStorage","config","cache","spark","namespace","getNamespace","toLowerCase","logger","console","parent","collection","Error","session","type","ready","default","clear","options","attributes","forEach","key","unset","_children","_collections","reset","initialize","args","prototype","_dataTypes","set","bind","on","model","trigger","inspect","depth","util","serialize","props","request","upload","when","eventName","rest","length","resolve","once","_filterSetParameters","value","attrs"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAIA;;;;AAEA;;;;AAOA;;;;AAEA;;;AAGA,IAAMA,cAAcC,yBAASC,MAAT,CAAgB;AAClCC,WAAS;AACPC,oBAAgB;AACdC,YAAM,EADQ;AAEdC,QAFc,gBAET;AACH,eAAO,mCAAqB,SAArB,EAAgC,IAAhC,CAAP;AACD;AAJa,KADT;AAOPC,sBAAkB;AAChBF,YAAM,EADU;AAEhBC,QAFgB,gBAEX;AACH,eAAO,mCAAqB,WAArB,EAAkC,IAAlC,CAAP;AACD;AAJe,KAPX;AAaPE,YAAQ;AACR;AACA;AACEC,aAAO,KAHD;AAINJ,YAAM,CACJ,OADI,EAEJ,cAFI,CAJA;AAQNC,QARM,gBAQD;AACH,YAAI,KAAKI,KAAL,IAAc,KAAKA,KAAL,CAAWF,MAA7B,EAAqC;AACnC,cAAMG,YAAY,KAAKC,YAAL,EAAlB;AACA,cAAID,SAAJ,EAAe;AACb,mBAAO,KAAKD,KAAL,CAAWF,MAAX,CAAkBG,UAAUE,WAAV,EAAlB,CAAP;AACD;;AAED,iBAAO,KAAKH,KAAL,CAAWF,MAAlB;AACD;;AAED,eAAO,EAAP;AACD;AAnBK,KAbD;;AAmCPM,YAAQ;AACNT,YAAM,CACJ,OADI,EAEJ,cAFI,CADA;AAKNC,QALM,gBAKD;AACH,eAAO,KAAKI,KAAL,CAAWI,MAAX,IAAqBC,OAA5B;AACD;AAPK,KAnCD;;AA6CPL,WAAO;AACLL,YAAM,CAAC,QAAD,CADD;AAELC,QAFK,gBAEA;AACH,YAAI,CAAC,KAAKU,MAAN,IAAgB,CAAC,KAAKC,UAA1B,EAAsC;AACpC,gBAAM,IAAIC,KAAJ,CAAU,iKAAV,CAAN;AACD;;AAED;AACA,YAAIF,SAAS,IAAb;AACA,eAAOA,OAAOA,MAAP,IAAiBA,OAAOC,UAA/B,EAA2C;AACzCD,mBAASA,OAAOA,MAAP,IAAiBA,OAAOC,UAAjC;AACD;;AAED,eAAOD,MAAP;AACD;AAdI;AA7CA,GADyB;;AAgElCG,WAAS;AACPH,YAAQ;AACNI,YAAM;AADA,KADD;AAIP;;;;;;;AAOAC,WAAO;AACLC,eAAS,IADJ;AAELF,YAAM;AAFD;AAXA,GAhEyB;;AAiFlC;;;;;;;;AAQAG,OAzFkC,iBAyF5BC,OAzF4B,EAyFnB;AAAA;;AACb,wBAAY,KAAKC,UAAjB,EAA6BC,OAA7B,CAAqC,UAACC,GAAD,EAAS;AAC5C,UAAIA,QAAQ,QAAZ,EAAsB;AACpB,cAAKC,KAAL,CAAWD,GAAX,EAAgBH,OAAhB;AACD;AACF,KAJD;;AAMA,wBAAY,KAAKK,SAAjB,EAA4BH,OAA5B,CAAoC,UAACC,GAAD,EAAS;AAC3C,YAAKA,GAAL,EAAUJ,KAAV;AACD,KAFD;;AAIA,wBAAY,KAAKO,YAAjB,EAA+BJ,OAA/B,CAAuC,UAACC,GAAD,EAAS;AAC9C,YAAKA,GAAL,EAAUI,KAAV;AACD,KAFD;;AAIA,WAAO,IAAP;AACD,GAzGiC;;;AA2GlC;;;;;;;AAOAC,YAlHkC,wBAkHd;AAAA;;AAAA,sCAANC,IAAM;AAANA,UAAM;AAAA;;AAClB,yBAAchC,yBAASiC,SAAT,CAAmBF,UAAjC,EAA6C,IAA7C,EAAmDC,IAAnD;;AAEA;AACA;AACA,SAAKE,UAAL,GAAkB,yBAAU,KAAKA,UAAf,CAAlB;AACA,wBAAY,KAAKA,UAAjB,EAA6BT,OAA7B,CAAqC,UAACC,GAAD,EAAS;AAC5C,UAAI,OAAKQ,UAAL,CAAgBR,GAAhB,EAAqBS,GAAzB,EAA8B;AAC5B,eAAKD,UAAL,CAAgBR,GAAhB,EAAqBS,GAArB,GAA2B,OAAKD,UAAL,CAAgBR,GAAhB,EAAqBS,GAArB,CAAyBC,IAAzB,CAA8B,MAA9B,CAA3B;AACD;AACF,KAJD;AAKA;;AAEA;AACA,SAAKC,EAAL,CAAQ,QAAR,EAAkB,UAACC,KAAD,EAAQf,OAAR,EAAoB;AACpC,UAAI,OAAKR,MAAT,EAAiB;AACf,eAAKA,MAAL,CAAYwB,OAAZ,aAA8B,OAAK5B,YAAL,GAAoBC,WAApB,EAA9B,EAAmE,OAAKG,MAAxE,EAAgF,MAAhF,EAAsFQ,OAAtF;AACD;AACF,KAJD;AAKD,GArIiC;;;AAuIlC;;;;;;;AAOAiB,SA9IkC,mBA8I1BC,KA9I0B,EA8InB;AACb,WAAOC,eAAKF,OAAL,CAAa,oBAAK,KAAKG,SAAL,CAAe;AACtCC,aAAO,IAD+B;AAEtC1B,eAAS,IAF6B;AAGtChB,eAAS;AAH6B,KAAf,CAAL,EAIhB,gBAJgB,EAIE,kBAJF,EAIsB,QAJtB,EAIgC,QAJhC,EAI0C,OAJ1C,EAImD,QAJnD,CAAb,EAI2E,EAACuC,YAAD,EAJ3E,CAAP;AAKD,GApJiC;AAsJlCI,SAtJkC,qBAsJjB;AAAA;;AACf,WAAO,eAAKpC,KAAL,EAAWoC,OAAX,yBAAP;AACD,GAxJiC;AA0JlCC,QA1JkC,oBA0JlB;AAAA;;AACd,WAAO,gBAAKrC,KAAL,EAAWqC,MAAX,0BAAP;AACD,GA5JiC;AA8JlCC,MA9JkC,gBA8J7BC,SA9J6B,EA8JT;AAAA;;AAAA,uCAANC,IAAM;AAANA,UAAM;AAAA;;AACvB,QAAIA,QAAQA,KAAKC,MAAL,GAAc,CAA1B,EAA6B;AAC3B,YAAM,IAAIjC,KAAJ,CAAU,oEAAV,CAAN;AACD;AACD,WAAO,sBAAY,UAACkC,OAAD,EAAa;AAC9B,aAAKC,IAAL,CAAUJ,SAAV,EAAqB;AAAA,2CAAIhB,IAAJ;AAAIA,cAAJ;AAAA;;AAAA,eAAamB,QAAQnB,IAAR,CAAb;AAAA,OAArB;AACD,KAFM,CAAP;AAGD,GArKiC;;;AAuKlC;;;;;;;;AAQAqB,sBA/KkC,gCA+Kb3B,GA/Ka,EA+KR4B,KA/KQ,EA+KD/B,OA/KC,EA+KQ;AACxC,QAAIgC,cAAJ;AACA,QAAI,wBAAS7B,GAAT,KAAiBA,QAAQ,IAA7B,EAAmC;AACjC6B,cAAQ7B,GAAR;AACAH,gBAAU+B,KAAV;AACD,KAHD,MAIK;AACHC,cAAQ,EAAR;AACAA,YAAM7B,GAAN,IAAa4B,KAAb;AACD;;AAED/B,cAAUA,WAAW,EAArB;;AAEA,WAAO,CAACgC,KAAD,EAAQhC,OAAR,CAAP;AACD;AA7LiC,CAAhB,CAApB,C,CAlBA;;;;kBAkNexB,W","file":"spark-plugin.js","sourcesContent":["/*!\n * Copyright (c) 2015-2017 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport util from 'util';\n\nimport AmpState from 'ampersand-state';\nimport {\n  cloneDeep,\n  isObject,\n  omit\n} from 'lodash';\n\nimport {makeSparkPluginStore} from './storage';\n\n/**\n * @class\n */\nconst SparkPlugin = AmpState.extend({\n  derived: {\n    boundedStorage: {\n      deps: [],\n      fn() {\n        return makeSparkPluginStore('bounded', this);\n      }\n    },\n    unboundedStorage: {\n      deps: [],\n      fn() {\n        return makeSparkPluginStore('unbounded', this);\n      }\n    },\n    config: {\n    // figure out why caching config breaks the refresh integration test\n    // but not the refresh automation test.\n      cache: false,\n      deps: [\n        'spark',\n        'spark.config'\n      ],\n      fn() {\n        if (this.spark && this.spark.config) {\n          const namespace = this.getNamespace();\n          if (namespace) {\n            return this.spark.config[namespace.toLowerCase()];\n          }\n\n          return this.spark.config;\n        }\n\n        return {};\n      }\n    },\n\n    logger: {\n      deps: [\n        'spark',\n        'spark.logger'\n      ],\n      fn() {\n        return this.spark.logger || console;\n      }\n    },\n\n    spark: {\n      deps: ['parent'],\n      fn() {\n        if (!this.parent && !this.collection) {\n          throw new Error('Cannot determine `this.spark` without `this.parent` or `this.collection`. Please initialize `this` via `children` or `collection` or set `this.parent` manually');\n        }\n\n        /* eslint consistent-this: [0] */\n        let parent = this;\n        while (parent.parent || parent.collection) {\n          parent = parent.parent || parent.collection;\n        }\n\n        return parent;\n      }\n    }\n  },\n\n  session: {\n    parent: {\n      type: 'any'\n    },\n    /**\n     * Indicates this plugin is ready to be used. Defaults to true but can be\n     * overridden by plugins as appropriate. Used by {@link SparkCore#read}\n     * @instance\n     * @memberof SparkPlugin\n     * @type {boolean}\n     */\n    ready: {\n      default: true,\n      type: 'boolean'\n    }\n  },\n\n  /**\n   * Overrides AmpersandState#clear to make sure we never unset `parent` and\n   * recursively visits children/collections.\n   * @instance\n   * @memberof SparkPlugin\n   * @param {Object} options\n   * @returns {SparkPlugin}\n   */\n  clear(options) {\n    Object.keys(this.attributes).forEach((key) => {\n      if (key !== 'parent') {\n        this.unset(key, options);\n      }\n    });\n\n    Object.keys(this._children).forEach((key) => {\n      this[key].clear();\n    });\n\n    Object.keys(this._collections).forEach((key) => {\n      this[key].reset();\n    });\n\n    return this;\n  },\n\n  /**\n   * Initializer\n   * @private\n   * @param {Object} attrs\n   * @param {Object} options\n   * @returns {undefined}\n   */\n  initialize(...args) {\n    Reflect.apply(AmpState.prototype.initialize, this, args);\n\n    // HACK to deal with the fact that AmpersandState#dataTypes#set is a pure\n    // function.\n    this._dataTypes = cloneDeep(this._dataTypes);\n    Object.keys(this._dataTypes).forEach((key) => {\n      if (this._dataTypes[key].set) {\n        this._dataTypes[key].set = this._dataTypes[key].set.bind(this);\n      }\n    });\n    // END HACK\n\n    // Propagate change:[attribute] events from children\n    this.on('change', (model, options) => {\n      if (this.parent) {\n        this.parent.trigger(`change:${this.getNamespace().toLowerCase()}`, this.parent, this, options);\n      }\n    });\n  },\n\n  /**\n   * @instance\n   * @memberof SparkPlugin\n   * @param {number} depth\n   * @private\n   * @returns {Object}\n   */\n  inspect(depth) {\n    return util.inspect(omit(this.serialize({\n      props: true,\n      session: true,\n      derived: true\n    }), 'boundedStorage', 'unboundedStorage', 'config', 'logger', 'spark', 'parent'), {depth});\n  },\n\n  request(...args) {\n    return this.spark.request(...args);\n  },\n\n  upload(...args) {\n    return this.spark.upload(...args);\n  },\n\n  when(eventName, ...rest) {\n    if (rest && rest.length > 0) {\n      throw new Error('#when() does not accept a callback, you must attach to its promise');\n    }\n    return new Promise((resolve) => {\n      this.once(eventName, (...args) => resolve(args));\n    });\n  },\n\n  /**\n   * Helper function for dealing with both forms of {@link AmpersandState#set()}\n   * @param {string} key\n   * @param {mixed} value\n   * @param {Object} options\n   * @private\n   * @returns {Array<Object, Object>}\n   */\n  _filterSetParameters(key, value, options) {\n    let attrs;\n    if (isObject(key) || key === null) {\n      attrs = key;\n      options = value;\n    }\n    else {\n      attrs = {};\n      attrs[key] = value;\n    }\n\n    options = options || {};\n\n    return [attrs, options];\n  }\n});\n\nexport default SparkPlugin;\n"]}