{"version":3,"sources":["mercury.js"],"names":["normalReconnectReasons","Mercury","SparkPlugin","extend","namespace","session","connected","default","type","connecting","socket","localClusterServiceUrls","derived","listening","deps","fn","connect","webSocketUrl","logger","info","resolve","spark","internal","device","registered","register","then","_connectWithBackoff","disconnect","backoffCall","abort","removeAllListeners","once","close","listen","stopListening","processRegistrationStatusEvent","message","_applyOverrides","event","headers","headerKeys","forEach","keyPath","_prepareUrl","feature","getFeature","haMessagingEnabled","useServiceCatalogUrl","wsUrl","webSharedMercury","url","parse","query","outboundWireFormat","bufferStates","aliasHttpStatus","mercuryRegistrationStatus","isRegistrationRefreshEnabled","multipleConnections","format","_attemptConnection","socketUrl","callback","Socket","attemptWSUrl","on","_onclose","_onmessage","args","_emit","all","credentials","getUserToken","token","open","forceCloseDelay","config","pingInterval","pongTimeout","toString","trackingId","sessionId","Date","now","metrics","submitClientMetrics","fields","success","tags","action","fetchNewUrls","catch","reason","code","getNumRetries","retries","UnknownResponse","refresh","NotAuthorized","force","BadRequest","Forbidden","warn","ConnectionError","error","markUrlFailedAndGetNew","reject","call","onComplete","err","undefined","backoff","setStrategy","ExponentialStrategy","initialDelay","backoffTimeReset","maxDelay","backoffTimeMax","maxRetries","failAfter","number","delay","Math","min","strategy_","nextBackoffDelay_","process","env","NODE_ENV","debug","stack","start","trigger","_getEventHandlers","eventType","split","name","handlers","handlerName","push","toLowerCase","unset","_reconnect","includes","envelope","data","ENABLE_MERCURY_LOGGING","reduce","promise","handler","oneFlight"],"mappings":"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","file":"mercury.js","sourcesContent":["/*!\n * Copyright (c) 2015-2017 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {SparkPlugin} from '@ciscospark/spark-core';\nimport {deprecated, oneFlight} from '@ciscospark/common';\nimport {camelCase, get, set} from 'lodash';\nimport backoff from 'backoff';\nimport Socket from './socket';\nimport {\n  BadRequest,\n  Forbidden,\n  NotAuthorized,\n  UnknownResponse,\n  ConnectionError\n  // NotFound\n} from './errors';\nimport url from 'url';\n\nconst normalReconnectReasons = [\n  'idle',\n  'done (forced)',\n  'pong not received',\n  'pong mismatch'\n];\n\nconst Mercury = SparkPlugin.extend({\n  namespace: 'Mercury',\n\n  session: {\n    connected: {\n      default: false,\n      type: 'boolean'\n    },\n    connecting: {\n      default: false,\n      type: 'boolean'\n    },\n    socket: 'object',\n    localClusterServiceUrls: 'object'\n  },\n\n  derived: {\n    listening: {\n      deps: ['connected'],\n      fn() {\n        return this.connected;\n      }\n    }\n  },\n\n  @oneFlight\n  connect(webSocketUrl) {\n    if (this.connected) {\n      this.logger.info('mercury: already connected, will not connect again');\n      return Promise.resolve();\n    }\n\n    this.connecting = true;\n    return Promise.resolve(this.spark.internal.device.registered || this.spark.internal.device.register())\n      .then(() => {\n        this.logger.info('mercury: connecting');\n\n        return this._connectWithBackoff(webSocketUrl);\n      });\n  },\n\n  @oneFlight\n  disconnect() {\n    return new Promise((resolve) => {\n      if (this.backoffCall) {\n        this.logger.info('mercury: aborting connection');\n        this.backoffCall.abort();\n      }\n\n      if (this.socket) {\n        this.socket.removeAllListeners('message');\n        this.once('offline', resolve);\n        this.socket.close();\n        return;\n      }\n\n      resolve();\n    });\n  },\n\n  @deprecated('Mercury#listen(): Use Mercury#connect() instead')\n  listen() {\n    /* eslint no-invalid-this: [0] */\n    return this.connect();\n  },\n\n  @deprecated('Mercury#stopListening(): Use Mercury#disconnect() instead')\n  stopListening() {\n    /* eslint no-invalid-this: [0] */\n    return this.disconnect();\n  },\n\n  processRegistrationStatusEvent(message) {\n    this.localClusterServiceUrls = message.localClusterServiceUrls;\n  },\n\n  _applyOverrides(event) {\n    if (!event.headers) {\n      return;\n    }\n    const headerKeys = Object.keys(event.headers);\n    headerKeys.forEach((keyPath) => {\n      set(event, keyPath, event.headers[keyPath]);\n    });\n  },\n\n  _prepareUrl(webSocketUrl) {\n    if (!webSocketUrl) {\n      webSocketUrl = this.spark.internal.device.webSocketUrl;\n    }\n\n    return this.spark.internal.feature.getFeature('developer', 'web-ha-messaging')\n      .then((haMessagingEnabled) => {\n        if (haMessagingEnabled) {\n          return this.spark.internal.device.useServiceCatalogUrl(webSocketUrl);\n        }\n        return webSocketUrl;\n      })\n      .then((wsUrl) => {\n        webSocketUrl = wsUrl;\n      })\n      .then(() => this.spark.internal.feature.getFeature('developer', 'web-shared-mercury'))\n      .then((webSharedMercury) => {\n        webSocketUrl = url.parse(webSocketUrl, true);\n        Object.assign(webSocketUrl.query, {\n          outboundWireFormat: 'text',\n          bufferStates: true,\n          aliasHttpStatus: true\n        });\n\n        if (webSharedMercury) {\n          Object.assign(webSocketUrl.query, {\n            mercuryRegistrationStatus: true,\n            isRegistrationRefreshEnabled: true\n          });\n          Reflect.deleteProperty(webSocketUrl.query, 'bufferStates');\n        }\n\n        if (get(this, 'spark.config.device.ephemeral', false)) {\n          webSocketUrl.query.multipleConnections = true;\n        }\n\n        return url.format(webSocketUrl);\n      });\n  },\n\n  _attemptConnection(socketUrl, callback) {\n    const socket = new Socket();\n    let attemptWSUrl;\n    socket.on('close', (...args) => this._onclose(...args));\n    socket.on('message', (...args) => this._onmessage(...args));\n    socket.on('sequence-mismatch', (...args) => this._emit('sequence-mismatch', ...args));\n\n    Promise.all([this._prepareUrl(socketUrl), this.spark.credentials.getUserToken()])\n      .then(([webSocketUrl, token]) => {\n        attemptWSUrl = webSocketUrl;\n        return socket.open(webSocketUrl, {\n          forceCloseDelay: this.config.forceCloseDelay,\n          pingInterval: this.config.pingInterval,\n          pongTimeout: this.config.pongTimeout,\n          token: token.toString(),\n          trackingId: `${this.spark.sessionId}_${Date.now()}`,\n          logger: this.logger\n        });\n      })\n      .then(() => {\n        this.socket = socket;\n        this.spark.internal.metrics.submitClientMetrics('web-ha-mercury', {\n          fields: {\n            success: true\n          },\n          tags: {\n            action: 'connected',\n            url: attemptWSUrl\n          }\n        });\n        callback();\n        return this.spark.internal.feature.getFeature('developer', 'web-ha-messaging')\n          .then((haMessagingEnabled) => {\n            if (haMessagingEnabled) {\n              return this.spark.internal.device.fetchNewUrls(attemptWSUrl);\n            }\n            return Promise.resolve();\n          });\n      })\n      .catch((reason) => {\n        // Suppress connection errors that appear to be network related. This\n        // may end up suppressing metrics during outages, but we might not care\n        // (especially since many of our outages happen in a way that client\n        // metrics can't be trusted).\n        if (reason.code !== 1006 && this.backoffCall && this.backoffCall.getNumRetries() > 0) {\n          this._emit('connection_failed', reason, {retries: this.backoffCall.getNumRetries()});\n        }\n        this.logger.info('mercury: connection attempt failed', reason);\n        // UnknownResponse is produced by IE for any 4XXX; treated it like a bad\n        // web socket url and let WDM handle the token checking\n        if (reason instanceof UnknownResponse) {\n          this.logger.info('mercury: received unknown response code, refreshing device registration');\n          return this.spark.internal.device.refresh()\n            .then(() => callback(reason));\n        }\n        // NotAuthorized implies expired token\n        if (reason instanceof NotAuthorized) {\n          this.logger.info('mercury: received authorization error, reauthorizing');\n          return this.spark.credentials.refresh({force: true})\n            .then(() => callback(reason));\n        }\n        // // NotFound implies expired web socket url\n        // else if (reason instanceof NotFound) {\n        //   this.logger.info(`mercury: received not found error, refreshing device registration`);\n        //   return this.spark.internal.device.refresh()\n        //     .then(() => callback(reason));\n        // }\n        // BadRequest implies current credentials are for a Service Account\n        // Forbidden implies current user is not entitle for Spark\n        if (reason instanceof BadRequest || reason instanceof Forbidden) {\n          this.logger.warn('mercury: received unrecoverable response from mercury');\n          this.backoffCall.abort();\n          return callback(reason);\n        }\n        if (reason instanceof ConnectionError) {\n          return this.spark.internal.feature.getFeature('developer', 'web-ha-messaging')\n            .then((haMessagingEnabled) => {\n              if (haMessagingEnabled) {\n                this.logger.info('mercury: received a generic connection error, will try to connect to another datacenter');\n                this.spark.internal.metrics.submitClientMetrics('web-ha-mercury', {\n                  fields: {\n                    success: false\n                  },\n                  tags: {\n                    action: 'failed',\n                    error: reason.message,\n                    url: attemptWSUrl\n                  }\n                });\n                return this.spark.internal.device.markUrlFailedAndGetNew(attemptWSUrl);\n              }\n              return null;\n            })\n            .then(() => callback(reason));\n        }\n\n        return callback(reason);\n      })\n      .catch((reason) => {\n        this.logger.error('mercury: failed to handle connection failure', reason);\n        callback(reason);\n      });\n  },\n\n  _connectWithBackoff(webSocketUrl) {\n    return new Promise((resolve, reject) => {\n      // eslint gets confused about whether or not call is actually used\n      // eslint-disable-next-line prefer-const\n      let call;\n      const onComplete = (err) => {\n        this.connecting = false;\n\n        this.backoffCall = undefined;\n        if (err) {\n          this.logger.info(`mercury: failed to connect after ${call.getNumRetries()} retries; log statement about next retry was inaccurate`);\n          return reject(err);\n        }\n        this.connected = true;\n        this._emit('online');\n        return resolve();\n      };\n\n      // eslint-disable-next-line prefer-reflect\n      call = backoff.call((callback) => {\n        this.logger.info(`mercury: executing connection attempt ${call.getNumRetries()}`);\n        this._attemptConnection(webSocketUrl, callback);\n      }, onComplete);\n\n      call.setStrategy(new backoff.ExponentialStrategy({\n        initialDelay: this.config.backoffTimeReset,\n        maxDelay: this.config.backoffTimeMax\n      }));\n\n      if (this.config.maxRetries) {\n        call.failAfter(this.config.maxRetries);\n      }\n\n      call.on('abort', () => {\n        this.logger.info('mercury: connection aborted');\n        reject();\n      });\n\n      call.on('callback', (err) => {\n        if (err) {\n          const number = call.getNumRetries();\n          const delay = Math.min(call.strategy_.nextBackoffDelay_, this.config.backoffTimeMax);\n\n          this.logger.info(`mercury: failed to connect; attempting retry ${number + 1} in ${delay} ms`);\n          /* istanbul ignore if */\n          if (process.env.NODE_ENV === 'development') {\n            this.logger.debug('mercury: ', err, err.stack);\n          }\n          return;\n        }\n        this.logger.info('mercury: connected');\n      });\n\n      call.start();\n\n      this.backoffCall = call;\n    });\n  },\n\n  _emit(...args) {\n    try {\n      this.trigger(...args);\n    }\n    catch (error) {\n      this.logger.error('mercury: error occurred in event handler', error);\n    }\n  },\n\n  _getEventHandlers(eventType) {\n    const [namespace, name] = eventType.split('.');\n    const handlers = [];\n\n    if (!this.spark[namespace] && !this.spark.internal[namespace]) {\n      return handlers;\n    }\n\n    const handlerName = camelCase(`process_${name}_event`);\n    if ((this.spark[namespace] || this.spark.internal[namespace])[handlerName]) {\n      handlers.push({\n        name: handlerName,\n        namespace\n      });\n    }\n    return handlers;\n  },\n\n  _onclose(event) {\n    // I don't see any way to avoid the complexity or statement count in here.\n    /* eslint complexity: [0] */\n\n    try {\n      const reason = event.reason && event.reason.toLowerCase();\n      const socketUrl = this.socket.url;\n      this.socket.removeAllListeners();\n      this.unset('socket');\n      this.connected = false;\n      this._emit('offline', event);\n\n      switch (event.code) {\n        case 1003:\n        // metric: disconnect\n          this.logger.info(`mercury: Mercury service rejected last message; will not reconnect: ${event.reason}`);\n          this._emit('offline.permanent', event);\n          break;\n        case 4000:\n          // metric: disconnect\n          this.logger.info('mercury: socket replaced; will not reconnect');\n          this._emit('offline.replaced', event);\n          break;\n        case 1001:\n        case 1005:\n        case 1006:\n        case 1011:\n          this.logger.info('mercury: socket disconnected; reconnecting');\n          this._emit('offline.transient', event);\n          this._reconnect(socketUrl);\n          // metric: disconnect\n          // if (code == 1011 && rason !== ping error) metric: unexpected disconnect\n          break;\n        case 1000:\n          if (normalReconnectReasons.includes(reason)) {\n            this.logger.info('mercury: socket disconnected; reconnecting');\n            this._emit('offline.transient', event);\n            this._reconnect(socketUrl);\n            // metric: disconnect\n            // if (reason === done forced) metric: force closure\n          }\n          else {\n            this.logger.info('mercury: socket disconnected; will not reconnect');\n            this._emit('offline.permanent', event);\n          }\n          break;\n        default:\n          this.logger.info('mercury: socket disconnected unexpectedly; will not reconnect');\n          // unexpected disconnect\n          this._emit('offline.permanent', event);\n      }\n    }\n    catch (error) {\n      this.logger.error('mercury: error occurred in close handler', error);\n    }\n  },\n\n  _onmessage(event) {\n    const envelope = event.data;\n    if (process.env.ENABLE_MERCURY_LOGGING) {\n      this.logger.debug('mercury: message envelope: ', envelope);\n    }\n\n    const data = envelope.data;\n    this._applyOverrides(data);\n    return this._getEventHandlers(data.eventType)\n      .reduce((promise, handler) => promise.then(() => {\n        const {namespace, name} = handler;\n        return new Promise((resolve) => resolve((this.spark[namespace] || this.spark.internal[namespace])[name](data)))\n          .catch((reason) => this.logger.error(`mercury: error occurred in autowired event handler for ${data.eventType}`, reason));\n      }), Promise.resolve())\n      .then(() => {\n        this._emit('event', event.data);\n        const [namespace] = data.eventType.split('.');\n        this._emit(`event:${namespace}`, envelope);\n        this._emit(`event:${data.eventType}`, envelope);\n      })\n      .catch((reason) => {\n        this.logger.error('mercury: error occurred processing socket message', reason);\n      });\n  },\n\n  _reconnect(webSocketUrl) {\n    this.logger.info('mercury: reconnecting');\n    return this.connect(webSocketUrl);\n  }\n});\n\nexport default Mercury;\n"]}