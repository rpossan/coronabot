{"version":3,"sources":["feature.js"],"names":["Feature","SparkPlugin","extend","namespace","getFeature","keyType","key","options","reject","Error","feature","spark","internal","device","features","get","resolve","full","serialize","value","setFeature","request","method","api","resource","userId","body","mutable","val","then","res","add","merge","setBundledFeatures","featureList","forEach","item","type","partitionedToggles","featureToggles","user","developer","initialize","args","prototype","listenToAndRun","trigger","bind"],"mappings":"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","file":"feature.js","sourcesContent":["/*!\n * Copyright (c) 2015-2017 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport '@ciscospark/internal-plugin-wdm';\nimport {partition} from 'lodash';\nimport {SparkPlugin} from '@ciscospark/spark-core';\n\nconst Feature = SparkPlugin.extend({\n  namespace: 'Feature',\n\n  /**\n   * Returns the value of the requested feature toggle.\n   * @param {string} keyType <developer|user|entitlement>\n   * @param {string} key\n   * @param {Object} options\n   * @param {boolean} options.full to get full feature record including metadata.\n   * @returns {string|boolean|number|FeatureModel|null}\n   */\n  getFeature(keyType, key, options) {\n    if (keyType !== 'developer' && keyType !== 'user' && keyType !== 'entitlement') {\n      return Promise.reject(new Error('Invalid feature keyType provided. Only `developer`, `user`, and `entitlement` feature toggles are permitted.'));\n    }\n\n    options = options || {};\n\n    const feature = this.spark.internal.device.features[keyType].get(key);\n\n    if (!feature) {\n      return Promise.resolve(null);\n    }\n\n    if (options.full) {\n      return Promise.resolve(feature.serialize());\n    }\n\n    return Promise.resolve(feature.value);\n  },\n\n  /**\n   * Issues request to server to set a value for a feature toggle.\n   * @param {string} keyType <developer|user>\n   * @param {string} key\n   * @param {string} value\n   * @returns {Promise} Refreshes the local device and resolves with the features endpoint's response.\n   */\n  setFeature(keyType, key, value) {\n    // Limit only to developer feature toggles for now.\n    if (keyType !== 'developer' && keyType !== 'user') {\n      return Promise.reject(new Error('Only `developer` and `user` feature toggles can be set.'));\n    }\n\n    return this.request({\n      method: 'POST',\n      api: 'feature',\n      resource: `features/users/${this.spark.internal.device.userId}/${keyType}`,\n      body: {\n        key,\n        mutable: true,\n        val: value\n      }\n    })\n      .then((res) => this.spark.internal.device.features[keyType].add(res.body, {merge: true}));\n  },\n\n  /**\n   * Issues request to server to set a value for a feature toggle.\n   * @param {array} featureList\n   * @returns {Promise} Refreshes the local device and resolves with the features endpoint`s response.\n   */\n  setBundledFeatures(featureList) {\n    featureList.forEach((item) => {\n      item.mutable = item.mutable || 'true';\n      if (item.type !== 'USER' && item.type !== 'DEV') {\n        item.type = 'USER';\n      }\n    });\n\n    return this.request({\n      method: 'POST',\n      api: 'feature',\n      resource: `features/users/${this.spark.internal.device.userId}/toggles`,\n      body: featureList\n    })\n      .then((res) => {\n        const partitionedToggles = partition(res.body.featureToggles, {type: 'USER'});\n        this.spark.internal.device.features.user.add(partitionedToggles[0], {merge: true});\n        this.spark.internal.device.features.developer.add(partitionedToggles[1], {merge: true});\n      });\n  },\n\n  initialize(...args) {\n    Reflect.apply(SparkPlugin.prototype.initialize, this, args);\n\n    this.listenToAndRun(this.spark, 'change:internal.device.features.developer', this.trigger.bind(this, 'change:developer'));\n    this.listenToAndRun(this.spark, 'change:internal.device.features.entitlement', this.trigger.bind(this, 'change:entitlement'));\n    this.listenToAndRun(this.spark, 'change:internal.device.features.user', this.trigger.bind(this, 'change:user'));\n  }\n});\n\nexport default Feature;\n"]}